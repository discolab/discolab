#!/usr/bin/env node
const { load: loadEnv } = require('dotenv');
const path = require('path');
const program = require('commander');
const startApiServer = require('../api/start-api-server');
const { writeDiscoJson } = require('../lib/disco-helpers');
const { allSettled } = require('../lib/promise-helpers');
const { getTorrentHashes } = require('../lib/torrent-helpers');
const { executeCmd } = require('../lib/shell-helpers');

const runCommand = (fn) => (...args) => {
  loadEnv({ path: path.join(__dirname, '../.env') });
  fn(...args);
};

program
  .version(require('../package.json').version);

program
  .command('api')
  .description('start disco media/restful server')
  .action(runCommand(() => {
    startApiServer(
      process.env.DISCOBOX_SERVER_PORT,
      process.env.MUSIC_LIB
    );
  }));

program
  .command('json <dir>')
  .description('generate disco.json files for new torrents')
  .action(runCommand((dir) => {
    getTorrentHashes(dir)
      .then((hashes) => allSettled(hashes.map(writeDiscoJson)))
  }));

program
  .command('sync')
  .description('uploads working copy of this repo to seedbox')
  .action(() => {
    executeCmd('rsync -arv --exclude=/Users/sasha/dev/discolab/discolab/node_modules /Users/sasha/dev/discolab/discolab subkid@chili.whatbox.ca:/home/subkid/')
  });

program.parse(process.argv);
